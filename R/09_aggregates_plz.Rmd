---
title: "Swiss-SEP project"
description: "Aggregating point data to PLZs"
date: "`r Sys.Date()`"
author:
  - name: Radoslaw Panczak 
    url: https://github.com/RPanczak
    affiliation: ISPM
    affiliation_url: https://www.ispm.unibe.ch/
    orcid_id: 0000-0001-5141-683X
# bibliography: biblio.bib
output:
  distill::distill_article:
    highlight: pygments
    toc: true
    toc_depth: 1
    number_sections: true
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      # fig.width=8, fig.height=6, 
                      # out.width="800px", out.height="600px",
                      dpi=300)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(scipen=999)
set.seed(12345)
library(pacman) 
p_load(tidyverse, haven, 
       sjmisc, sjPlot,
       sf, tmap)

tmap_mode("view")
```

# Raw data 

## PLZ

Oct 2020 release from [cadastre.ch](https://www.cadastre.ch/en/services/service/registry/plz.html)

```{r}
plz_20_10 <- read_rds("data/PLZ/plz_20_10.Rds")
```

Dataset consists of `r scales::number(length(unique(plz_20_10$PLZ)), big.mark = ",")` PLZs.

## Swiss-SEP 

<!-- Using both 1.0 and 2.0 versions -->
Using version 1.0 for now. 

```{r echo=FALSE}
sep1 <- read_rds("data/Swiss-SEP1/ssep_user_geo.Rds") %>% 
  st_transform(crs = 2056) %>% 
  select(v0_buildid, ssep, ssep_d) %>% 
  rename(ssep1 = ssep,
         ssep1_d = ssep_d) %>% 
  mutate(ssep1_d = factor(ssep1_d,
                          levels = 1:10,
                          labels = c("1st - lowest", 
                                     "2", "3", "4", 
                                     "5th decile", 
                                     "6", "7", "8", "9", 
                                     "10th - highest")))

# sep1 %>% 
#   filter(v0_buildid == 982041) %>% 
#   qtm()
```

Dataset consists of `r scales::number(nrow(sep1), big.mark = ",")` n'hoods, each assigned to decile of index.

```{r}
st_drop_geometry(sep1) %>% 
  frq(ssep1_d)
```

```{r eval=FALSE, include=FALSE}
sep2 <- read_rds("data/Swiss-SEP2/ssep2_user_geo.Rds") %>% 
  st_transform(crs = 2056) %>% 
  select(gisid, ssep2, ssep2_d) %>% 
  mutate(ssep2_d = factor(ssep2_d,
                          levels = 1:10,
                          labels = c("1st - lowest", 
                                     "2", "3", "4", 
                                     "5th decile", 
                                     "6", "7", "8", "9", 
                                     "10th - highest")))
```

## STATPOP

```{r include=FALSE}
r18_bu_orig <- read_dta("data-raw/statpop/r18_bu_orig.dta")
# View(r18_bu_orig)

r18_bu <- r18_bu_orig %>% 
  filter(between(r18_gklas, 1110, 1122)) %>% 
  filter(!is.na(r18_gklas)) %>% 
  select(-r18_cant, -r18_cant_sh,
         -r18_ecoord_h, -r18_ncoord_h, 
         -r18_plzz,
         -r18_gklas, -r18_fgkod, -r18_buildper, 
         -r18_nrfloor, -r18_nrdwell, 
         -r18_quarter, -r18_comm, -r18_buildcat) %>% 
  select(-r18_nrpers_main, -r18_nrpers_perm) %>% 
  # filter(!is.na(r18_ncoord)) %>% 
  # filter(!is.na(r18_ecoord)) %>% 
  st_as_sf(coords = c("r18_ecoord", "r18_ncoord"), 
           crs = 2056,
           remove = TRUE)
```

Using data from `STATPOP` **2018**. Excluding `r scales::number(nrow(filter(r18_bu_orig, !between(r18_gklas, 1110, 1122))), big.mark = ",")` nonresidential buildings and `r scales::number(nrow(filter(r18_bu_orig, is.na(r18_gklas))), big.mark = ",")` buildings missing information on classifications. 

Used dataset consists of `r scales::number(nrow(r18_bu), big.mark = ",")` buildings.

<!-- The nearest building with SSEP 1 & 2 were then found and population was aggregated by deciles. -->

The nearest building with SSEP 1 was found; point dataset was then overlaid with PLZ boundaries and summary measures of population based index were created and population level SEP was aggregated by PLZ. 

`r18_nrpers_total` was used for population - slightly different populations would be obtained with different conceptual models of *residential populations* by using either `r18_nrpers_main` or `r18_nrpers_perm` variables


```{r include=FALSE}
rm(r18_bu_orig)
gc()
```

# PLZ averages

## 'nhood based

```{r}
ssep1_plz_20 <- 
  st_join(sep1, plz_20_10, join = st_intersects) 

ssep1_plz_20_neigh <- ssep1_plz_20 %>% 
  # covering one point outside of the map
  mutate(PLZ = ifelse(v0_buildid == 982041, 2414, PLZ)) %>% 
  st_drop_geometry() %>% 
  group_by(PLZ) %>% 
  summarise(n = n(),
            ssep1_mean = mean(ssep1),
            ssep1_median = median(ssep1)) %>% 
  ungroup() 

breaks1 <- sep1 %>% 
  st_drop_geometry() %>% 
  group_by(ssep1_d) %>% 
  summarize(min = min(ssep1),
            max = max(ssep1))

# sep1$temp <- cut(sep1$ssep1, breaks = c(breaks1$min, 100),
#                  include.lowest = TRUE,
#                  labels = c("1st - lowest", 
#                             "2", "3", "4", 
#                             "5th decile", 
#                             "6", "7", "8", "9", 
#                             "10th - highest"))
# 
# table(sep1$ssep1_d, sep1$temp)

mapdata_neigh <- left_join(plz_20_10, ssep1_plz_20_neigh) %>% 
  filter(!is.na(ssep1_median)) %>% 
  mutate(mean_ssep1_samp_d = ntile(ssep1_mean, 10),
         median_ssep1_samp_d = ntile(ssep1_median, 10)) %>% 
  mutate(mean_ssep1_samp_d = factor(mean_ssep1_samp_d,
                                    levels = 1:10,
                                    labels = c("1st - lowest", 
                                               "2", "3", "4", 
                                               "5th decile", 
                                               "6", "7", "8", "9", 
                                               "10th - highest"))) %>% 
  mutate(median_ssep1_samp_d = factor(median_ssep1_samp_d,
                                      levels = 1:10,
                                      labels = c("1st - lowest", 
                                                 "2", "3", "4", 
                                                 "5th decile", 
                                                 "6", "7", "8", "9", 
                                                 "10th - highest")))

mapdata_neigh$mean_ssep1_full_d <- cut(mapdata_neigh$ssep1_mean, 
                                       breaks = c(breaks1$min, 100),
                                       include.lowest = TRUE,
                                       labels = c("1st - lowest", 
                                                  "2", "3", "4", 
                                                  "5th decile", 
                                                  "6", "7", "8", "9", 
                                                  "10th - highest"))

mapdata_neigh$median_ssep1_full_d <- cut(mapdata_neigh$ssep1_median, 
                                         breaks = c(breaks1$min, 100),
                                         include.lowest = TRUE,
                                         labels = c("1st - lowest", 
                                                    "2", "3", "4", 
                                                    "5th decile", 
                                                    "6", "7", "8", "9", 
                                                    "10th - highest"))

write_rds(mapdata_neigh, "data/mapdata_neigh.rds")

# mapdata_neigh %>% 
#   filter(is.na(ssep1_median)) %>% 
#   tm_shape() +
#   tm_dots()
```

Watch out for small n!
- hospitals: 4031, 1011, 4101, 5017, 3010, 5404, 8208  
- generally small: 6441, 6068, 7517  
- no pop? Ried-Brig: 3901, Laura: 6549  
- Technopark Luzern: 6039  
- Jungfraujoch: 3801  
- Genève Aéroport: 1215  
- remote: 6867, 7710  
- Kloster Fahr: 8109  
- uni: 1015  

```{r}
mapdata_neigh %>% 
  filter(n < 9) %>% 
  qtm(borders = "red", fill = "red")
```

### Final map using median index

Bubbles scaled to number of 'nhoods.

```{r, layout="l-body-outset"}
mapdata_neigh %>% 
  tm_shape() +
  tm_dots(size = "n", col = "ssep1_median", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

### Deciles using sample of PLZs vs 'original' deciles

```{r}
frq(mapdata_neigh$median_ssep1_samp_d)
frq(mapdata_neigh$median_ssep1_full_d)
```

```{r, layout="l-page"}
mapdata_neigh %>% 
  tm_shape() +
  tm_fill(col = c("median_ssep1_samp_d", "median_ssep1_full_d"), 
          palette = "RdYlGn")
```

## Population based

```{r eval=FALSE, include=FALSE}
# join to sep1
r18_bu_sep1 <- 
  st_join(r18_bu, sep1, join = st_nearest_feature)

# nearest <- st_nearest_feature(r18_bu, sep1)
# r18_bu_sep1$dist1 <- st_distance(r18_bu_sep1, sep1[nearest, ], by_element = TRUE)
# rm(nearest)

# # join to sep2
# r18_bu_sep2 <- st_join(r18_bu, sep2, join = st_nearest_feature)
# 
# # nearest <- st_nearest_feature(r18_bu_sep2, sep2)
# # r18_bu_sep2$dist2 <- st_distance(r18_bu_sep2, sep2[nearest, ], by_element = TRUE)
# # rm(nearest)

# View(st_drop_geometry(r18_bu_sep1))

r18_bu_sep1_plz <- 
  st_join(r18_bu_sep1, plz_20_10, join = st_intersects) 

# View(st_drop_geometry(r18_bu_sep1_plz))

write_rds(r18_bu_sep1_plz, "data/statpop/r18_bu_sep1_plz.rds")
```

```{r}
r18_bu_sep1_plz <- read_rds("data/statpop/r18_bu_sep1_plz.rds") 
```

```{r}
ssep1_plz_20_pop <- r18_bu_sep1_plz %>% 
  st_drop_geometry() %>% 
  select(-r18_gdename, -r18_plz4, -ssep1_d) %>% 
  uncount(r18_nrpers_total) %>% 
  group_by(PLZ) %>% 
  summarise(n = n(),
            ssep1_mean = mean(ssep1),
            ssep1_median = median(ssep1)) %>% 
  ungroup() 

mapdata_pop <- left_join(plz_20_10, ssep1_plz_20_pop) %>% 
  filter(!is.na(ssep1_median)) %>% 
  mutate(mean_ssep1_samp_d = ntile(ssep1_mean, 10),
         median_ssep1_samp_d = ntile(ssep1_median, 10)) %>% 
  mutate(mean_ssep1_samp_d = factor(mean_ssep1_samp_d,
                                    levels = 1:10,
                                    labels = c("1st - lowest", 
                                               "2", "3", "4", 
                                               "5th decile", 
                                               "6", "7", "8", "9", 
                                               "10th - highest"))) %>% 
  mutate(median_ssep1_samp_d = factor(median_ssep1_samp_d,
                                      levels = 1:10,
                                      labels = c("1st - lowest", 
                                                 "2", "3", "4", 
                                                 "5th decile", 
                                                 "6", "7", "8", "9", 
                                                 "10th - highest")))

mapdata_pop$mean_ssep1_full_d <- cut(mapdata_pop$ssep1_mean, 
                                     breaks = c(breaks1$min, 100),
                                     include.lowest = TRUE,
                                     labels = c("1st - lowest", 
                                                "2", "3", "4", 
                                                "5th decile", 
                                                "6", "7", "8", "9", 
                                                "10th - highest"))

mapdata_pop$median_ssep1_full_d <- cut(mapdata_pop$ssep1_median, 
                                       breaks = c(breaks1$min, 100),
                                       include.lowest = TRUE,
                                       labels = c("1st - lowest", 
                                                  "2", "3", "4", 
                                                  "5th decile", 
                                                  "6", "7", "8", "9", 
                                                  "10th - highest"))

write_rds(mapdata_pop, "data/mapdata_pop.rds")
```

### Final map using median index

Bubbles scaled to number of people (2018)

```{r, layout="l-body-outset"}
mapdata_pop %>% 
  tm_shape() +
  tm_dots(size = "n", col = "ssep1_median", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

### Deciles using sample of PLZs vs 'original' deciles

```{r}
frq(mapdata_pop$median_ssep1_samp_d)
frq(mapdata_pop$median_ssep1_full_d)
```

```{r, layout="l-page"}
mapdata_pop %>% 
  tm_shape() +
  tm_fill(col = c("median_ssep1_samp_d", "median_ssep1_full_d"), 
          palette = "RdYlGn")
```
