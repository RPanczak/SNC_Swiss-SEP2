---
title: "Swiss-SEP project"
description: "Aggregating SEP3 point data to PLZs"
date: "`r Sys.Date()`"
author:
  - name: Radoslaw Panczak 
    url: https://github.com/RPanczak
    affiliation: ISPM
    affiliation_url: https://www.ispm.unibe.ch/
    orcid_id: 0000-0001-5141-683X
# bibliography: biblio.bib
output:
  distill::distill_article:
    highlight: pygments
    toc: true
    toc_depth: 1
    number_sections: true
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      # fig.width=8, fig.height=6, 
                      # out.width="800px", out.height="600px",
                      dpi=300)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(scipen=999)
set.seed(12345)
library(pacman) 
p_load(tidyverse, haven, scales,
       sjmisc, sjPlot,
       sf, tmap)

tmap_mode("view")
```

<!-- ------------------------------------------------------------ --> 

# Raw data 

## PLZ

Oct 2020 release from [cadastre.ch](https://www.cadastre.ch/en/services/service/registry/plz.html)

```{r warning=FALSE}
plz_20_10 <- st_read("data/PLZ/plz_20_10.shp") 

plz_20_10_mp <- plz_20_10 %>% 
  group_by(PLZ) %>% 
  summarise(PLZ = first(PLZ)) %>%
  st_cast("MULTIPOLYGON") %>% 
  ungroup()

plz_20_10_centr <- st_centroid(plz_20_10_mp)
```

Dataset consists of `r number(length(unique(plz_20_10$PLZ)), big.mark = ",")` PLZs.

## Swiss-SEP 

Using version 3.0. 

```{r echo=FALSE}
sep3 <- read_rds("FINAL/RDS/ssep3_user_geo.Rds") %>% 
  select(gisid, ssep3, ssep3_d) %>% 
  mutate(ssep3_d = factor(ssep3_d,
                          levels = 1:10,
                          labels = c("1st - lowest", 
                                     "2", "3", "4", 
                                     "5th decile", 
                                     "6", "7", "8", "9", 
                                     "10th - highest")))

# View(st_drop_geometry(sep3))
```

Dataset consists of `r number(nrow(sep3), big.mark = ",")` n'hoods, each assigned to decile of index. 

<aside>
Decile numbers are not 'exact' due to changes that occur when `SEP2` index is used in place of `SEP1` index in areas with new buildings. See the main paper for more explanations of that.
</aside>

```{r}
st_drop_geometry(sep3) %>% 
  frq(ssep3_d)
```

## STATPOP

```{r include=FALSE}
r18_bu_orig <- read_dta("../SNC_core/data-raw/statpop/r18_bu_orig.dta")
# View(r18_bu_orig)

r18_bu <- r18_bu_orig %>% 
  filter(between(r18_gklas, 1110, 1122)) %>% 
  filter(!is.na(r18_gklas)) %>% 
  select(-r18_cant, -r18_cant_sh,
         -r18_ecoord_h, -r18_ncoord_h, 
         -r18_plzz,
         -r18_gklas, -r18_fgkod, -r18_buildper, 
         -r18_nrfloor, -r18_nrdwell, 
         -r18_quarter, -r18_comm, -r18_buildcat) %>% 
  select(-r18_nrpers_total, -r18_nrpers_perm) %>% 
  # filter(!is.na(r18_ncoord)) %>% 
  # filter(!is.na(r18_ecoord)) %>% 
  st_as_sf(coords = c("r18_ecoord", "r18_ncoord"), 
           crs = 2056,
           remove = TRUE)
```

Using data from `STATPOP` **2018**. Excluding `r number(nrow(filter(r18_bu_orig, !between(r18_gklas, 1110, 1122))), big.mark = ",")` non-residential buildings and `r number(nrow(filter(r18_bu_orig, is.na(r18_gklas))), big.mark = ",")` buildings missing information on classifications. 

Used dataset consists of `r number(nrow(r18_bu), big.mark = ",")` buildings.

The nearest building with SSEP 3 was found; point dataset was then overlaid with PLZ boundaries and summary measures of population based index were created and population level SEP was aggregated by PLZ. 

`r18_nrpers_main` was used for calculating population. Overall, **total population** after exclusions consists of `r number(sum(r18_bu$r18_nrpers_main), big.mark = ",")`.  

<aside>
Slightly different populations would be obtained with different conceptual models of *residential populations* by using either `r18_nrpers_total` or `r18_nrpers_perm` variables. See `STATPOP` docs for details. 
</aside>

```{r include=FALSE}
rm(r18_bu_orig); gc()
```


```{r eval=FALSE, include=FALSE}
# simple solution to average n'hoods
ssep3_plz_20 <- st_join(sep3, plz_20_10, join = st_intersects) 

# # does not matter here if multipart feature is used
# temp <- st_join(sep3, plz_20_10_mp, join = st_intersects) 
# table(all.equal(st_drop_geometry(ssep3_plz_20), st_drop_geometry(temp)))

# ssep3_plz_20 %>% filter(is.na(PLZ))
# View(st_drop_geometry(ssep3_plz_20))

ssep3_plz_20_10_neigh <- ssep3_plz_20 %>% 
  st_drop_geometry() %>% 
  group_by(PLZ) %>% 
  summarise(n = n(),
            ssep3_mean = mean(ssep3),
            ssep3_median = median(ssep3)) %>% 
  ungroup() 

plz_n <- left_join(plz_20_10, ssep3_plz_20_10_neigh) 
```

<!-- ------------------------------------------------------------ --> 

# Population based averages

```{r eval=FALSE, include=FALSE}
# join to sep3
r18_bu_sep3 <- 
  st_join(r18_bu, sep3, join = st_nearest_feature)

nearest <- st_nearest_feature(r18_bu, sep3)
r18_bu_sep3$dist1 <- st_distance(r18_bu_sep3, sep3[nearest, ], by_element = TRUE)
rm(nearest)

# View(st_drop_geometry(r18_bu_sep3))

r18_bu_sep3_plz <- 
  st_join(r18_bu_sep3, plz_20_10, join = st_intersects) 

# View(st_drop_geometry(r18_bu_sep3_plz))

write_rds(r18_bu_sep3_plz, "data/statpop/r18_bu_sep3_plz.rds")
```

```{r}
r18_bu_sep3_plz <- read_rds("data/statpop/r18_bu_sep3_plz.rds") 
```

```{r}
ssep3_plz_20_10_pop <- r18_bu_sep3_plz %>% 
  st_drop_geometry() %>% 
  select(-r18_gdename, -r18_plz4, -ssep3_d) %>% 
  uncount(r18_nrpers_main) %>% 
  group_by(PLZ) %>% 
  summarise(n = n(),
            ssep3_mean = mean(ssep3),
            ssep3_median = median(ssep3)) %>% 
  ungroup() %>% 
  filter(n > 10) %>% 
  filter(! PLZ %in% c(5017, 8109))

ssep3_plz_20_10_pop_geo <- right_join(plz_20_10_mp, ssep3_plz_20_10_pop) %>% 
  filter(!is.na(ssep3_median)) %>% 
  mutate(ssep3_mean_q = ntile(ssep3_mean, 5),
         ssep3_median_q = ntile(ssep3_median, 5),
         ssep3_mean_d = ntile(ssep3_mean, 10),
         ssep3_median_d = ntile(ssep3_median, 10)) %>% 
  mutate(ssep3_mean_d = factor(ssep3_mean_d,
                               levels = 1:10,
                               labels = c("1st - lowest", 
                                          "2", "3", "4", 
                                          "5th decile", 
                                          "6", "7", "8", "9", 
                                          "10th - highest"))) %>% 
  mutate(ssep3_median_d = factor(ssep3_median_d,
                                 levels = 1:10,
                                 labels = c("1st - lowest", 
                                            "2", "3", "4", 
                                            "5th decile", 
                                            "6", "7", "8", "9", 
                                            "10th - highest"))) %>% 
  mutate(ssep3_mean_q = factor(ssep3_mean_q,
                               levels = 1:5,
                               labels = c("1st - lowest", 
                                          "2",  
                                          "3rd decile", 
                                          "4", 
                                          "5th - highest"))) %>% 
  mutate(ssep3_median_q = factor(ssep3_median_q,
                                 levels = 1:5,
                                 labels = c("1st - lowest", 
                                            "2",  
                                            "3rd decile", 
                                            "4", 
                                            "5th - highest")))

# has to add up!
stopifnot(nrow(ssep3_plz_20_10_pop) == length(unique(ssep3_plz_20_10_pop_geo$PLZ)))
```


```{r include=FALSE}
sf::st_write(ssep3_plz_20_10_pop_geo, "data/PLZ/ssep3_plz_20_10_pop_geo.shp", delete_layer = TRUE)
write_rds(ssep3_plz_20_10_pop_geo, "data/PLZ/ssep3_plz_20_10_pop_geo.rds")
write_rds(st_drop_geometry(ssep3_plz_20_10_pop_geo), "data/PLZ/ssep3_plz_20_10_pop.rds")
haven::write_dta(st_drop_geometry(ssep3_plz_20_10_pop_geo), "data/PLZ/ssep3_plz_20_10_pop.dta")
write_csv(st_drop_geometry(ssep3_plz_20_10_pop_geo), "data/PLZ/ssep3_plz_20_10_pop.csv")
```

## Final map using median index deciles

```{r}
frq(ssep3_plz_20_10_pop_geo$ssep3_median_d)
# frq(ssep3_plz_20_10_pop_geo$ssep3_mean_d)
```

Index deciles, bubbles scaled to population (2018)

```{r, layout="l-body-outset"}
ssep3_plz_20_10_pop_geo %>% 
  tm_shape() +
  tm_dots(size = "n", col = "ssep3_median_d", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

## Comparing mean and median

```{r}
table(ssep3_plz_20_10_pop_geo$ssep3_median_d, ssep3_plz_20_10_pop_geo$ssep3_mean_d)
```

```{r eval=FALSE, include=FALSE, layout="l-page"}
ssep3_plz_20_10_pop_geo %>% 
  tm_shape() +
  tm_fill(col = c("ssep3_median_d", "ssep3_mean_d"), 
          palette = "RdYlGn")
```

## Small PLZs

```{r}
small <- r18_bu_sep3_plz %>% 
  st_drop_geometry() %>% 
  select(-r18_gdename, -r18_plz4, -ssep3_d) %>% 
  uncount(r18_nrpers_main) %>% 
  group_by(PLZ) %>% 
  summarise(n = n(),
            ssep3_mean = mean(ssep3),
            ssep3_median = median(ssep3)) %>% 
  ungroup() %>% 
  filter(n < 11 | PLZ %in% c(5017, 8109)) %>% 
  arrange(n)
```

`r number(length(unique(small$PLZ)), big.mark = ",")` PLZs with population below 10 or classified as non-residential were excluded from the calculations above. 

- remote? no / small pop?: 
    - Poschiavo 7710   
    - Ried-Brig 3901   
    - Lumnezia 7110
    - Kerns 6068  
    - Termen 3913 
    - Engadin/Segl 7517

- hospital 
    - Klinik Barmelweid 5017

- not small but can that be qualified as residential?
    - Kloster Fahr 8109

```{r}
# Watch out for unusual PLZs with small or no pops!
# - hospitals: 4031, 1011, 4101, 5017, 3010, 5404, 8208  
# - generally small: 6441, 6068, 7517  
# - no pop? Ried-Brig: 3901, Laura: 6549  
# - Technopark Luzern: 6039  
# - Jungfraujoch: 3801  
# - Genève Aéroport: 1215  
# - remote: 6867, 7710  
# - Kloster Fahr: 8109  
# - uni: 1015 

# small %>%
#   filter(PLZ == 8109)

small_geo <- right_join(plz_20_10_mp, small) 

small_geo %>% 
  filter(n < 11) %>% 
  qtm(borders = "red", fill = "red")
```