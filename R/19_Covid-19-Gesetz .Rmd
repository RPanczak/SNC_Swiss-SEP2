---
title: "Swiss-SEP project"
description: "Covid-19 laws & municipality level SEP"
date: "`r Sys.Date()`"
author:
  - name: Radoslaw Panczak 
    url: https://github.com/RPanczak
    affiliation: ISPM
    affiliation_url: https://www.ispm.unibe.ch/
    orcid_id: 0000-0001-5141-683X
# bibliography: biblio.bib
output:
  distill::distill_article:
    highlight: pygments
    toc: true
    toc_depth: 2
    number_sections: true
editor_options: 
  chunk_output_type: console
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

# removed from cran?
# devtools::install_github("politanch/swissdd")

library(pacman) 
p_load(tidyverse, haven, readxl, magrittr,
       sjmisc, weights, ggridges, hrbrthemes, DT,
       sf, tmap,
       swissdd)

tmap_mode("view")
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

# Data 

## Municipalities

swissBOUNDARIES3D **Jan 2022** from [swisstopo](https://shop.swisstopo.admin.ch/en/products/landscape/boundaries3D).  

```{r include=FALSE}
gem_22 <- read_rds("../ISPM_geo/data/swisstopo/swissBOUNDARIES3D/gem_22.Rds") %>% 
  st_transform(crs = 2056) %>% 
  rename(mun_id = GMDNR)
```

swisstopo dataset consists of `r scales::number(length(unique(gem_22$mun_id)), big.mark = ",")` municipalities.  

## June vote

Data from `swissdd` [package](https://github.com/politanch/swissdd).    

### Data 

> Bundesgesetz vom 25.09.2020 über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz)

```{r}
covid_jun <- get_nationalvotes(votedates = "2021-06-13", 
                               geolevel = "municipality") %>% 
  filter(name == "Bundesgesetz über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz)") %>% 
  select(-name)
```

### Results preview

```{r echo=FALSE}
plot_nationalvotes(votedate = "2021-06-13", 
                   vote_id = 6430, geolevel = "municipality")
```

### Votes from abroad  

Are excluded  

```{r}
covid_jun %>% 
  filter(str_detect(mun_name, fixed("Ausland")) | str_detect(mun_name, fixed("l'étranger"))) %>% 
  select(mun_name, jaStimmenAbsolut, jaStimmenInProzent)
```

```{r}
covid_jun %<>% 
  filter(! str_detect(mun_name, fixed("Ausland"))) %>% 
  filter(! str_detect(mun_name, fixed("l'étranger"))) %>% 
  mutate(mun_id = as.numeric(mun_id))
```

Dataset consists of `r scales::number(length(unique(covid_jun$mun_id)), big.mark = ",")` communities.

### Link to municipalities

Using `GMDNR` / `mun_id` for deterministic linkage.  

```{r}
covid_jun_gem <- gem_22 %>%  
  left_join(covid_jun)
```

<!-- There are few communities that exist in the voting dataset but not on the map:   -->

```{r eval=FALSE}
covid_jun %>% 
  select(mun_id, mun_name) %>%
  anti_join(st_drop_geometry(gem_22)) %>% 
  arrange(mun_name)
```

There are few communities that exist on the map but do not exist in the voting dataset:   

```{r echo=FALSE}
covid_jun_gem %>% 
  st_drop_geometry() %>% 
  filter(is.na(jaStimmenInProzent)) %>% 
  select(mun_id, NAME)
```

## November vote

> Änderung des Bundesgesetzes über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz) (Härtefälle, Arbeitslosenversicherung, familienergänzende Kinderbetreuung, Kulturschaffende, Veranstaltungen)  

### Data 

```{r}
covid_nov <- get_nationalvotes(votedates = "2021-11-28", 
                               geolevel = "municipality") %>% 
  filter(name == "Änderung des Bundesgesetzes über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz) (Härtefälle, Arbeitslosenversicherung, familienergänzende Kinderbetreuung, Kulturschaffende, Veranstaltungen)") %>% 
  select(-name)
```

### Results preview

```{r echo=FALSE}
plot_nationalvotes(votedate = "2021-11-28", 
                   vote_id = 6500, geolevel = "municipality")
```

### Votes from abroad  

Are excluded  

```{r}
covid_nov %>% 
  filter(str_detect(mun_name, fixed("Ausland")) | str_detect(mun_name, fixed("l'étranger"))) %>% 
  select(mun_name, jaStimmenAbsolut, jaStimmenInProzent)
```

```{r include=FALSE}
covid_nov %<>% 
  filter(! str_detect(mun_name, fixed("Ausland"))) %>% 
  filter(! str_detect(mun_name, fixed("l'étranger"))) %>% 
  mutate(mun_id = as.numeric(mun_id))
```

Dataset consists of `r scales::number(length(unique(covid_nov$mun_id)), big.mark = ",")` communities.

### Link to municipalities

Using `GMDNR` / `mun_id` for deterministic linkage.  

```{r}
covid_nov_gem <- gem_22 %>%  
  left_join(covid_nov)
```

<!-- There are few communities that exist in the voting dataset but not on the map:   -->

```{r eval=FALSE}
covid_nov %>% 
  select(mun_id, mun_name) %>%
  anti_join(st_drop_geometry(gem_22)) %>% 
  arrange(mun_name)
```

There are few communities that exist on the map but do not exist in the voting dataset:  

```{r echo=FALSE}
covid_nov_gem %>% 
  st_drop_geometry() %>% 
  filter(is.na(jaStimmenInProzent)) %>% 
  select(mun_id, NAME)
```

## Swiss-SEP 

Using version 3.0. 

```{r echo=FALSE}
sep3 <- read_rds("FINAL/RDS/ssep3_user_geo.Rds") %>% 
  select(gisid, ssep3, ssep3_d) %>% 
  mutate(ssep3_d = factor(ssep3_d,
                          levels = 1:10,
                          labels = c("1st - lowest", 
                                     "2", "3", "4", 
                                     "5th decile", 
                                     "6", "7", "8", "9", 
                                     "10th - highest")))
```

Dataset consists of `r scales::number(nrow(sep3), big.mark = ",")` n'hoods, each assigned to decile of index.

```{r}
st_drop_geometry(sep3) %>% 
  frq(ssep3_d)
```

## STATPOP

Using 2019 STATPOP population file.  

```{r include=FALSE}
r19_bu <- read_dta("../SNC_core/data-raw/statpop/r19_bu_orig.dta") %>% 
  select(r19_egid_snc, 
         r19_ecoord, r19_ncoord,
         r19_gdename, r19_nrpers_main) %>% 
  # select(r19_nrpers_total, r19_nrpers_perm) %>% 
  # filter(!is.na(r19_ncoord)) %>% 
  # filter(!is.na(r19_ecoord)) %>% 
  filter(r19_nrpers_main > 0) %>% 
  st_as_sf(coords = c("r19_ecoord", "r19_ncoord"), 
           crs = 2056,
           remove = TRUE)
```

Dataset consists of `r scales::number(nrow(r19_bu), big.mark = ",")` buildings with at least one resident.

The nearest building with SSEP 3 was found; point dataset was then overlaid with municipality boundaries and summary measures of population based index were created and population level SEP was aggregated by municipality. `r19_nrpers_main` was used as population weight.^[Slightly different populations would be obtained with different conceptual models of *residential populations* by using either `r19_nrpers_total` or `r19_nrpers_perm` variables!]

## Population based community averages of SEP

```{r eval=FALSE, include=TRUE}
r19_bu_sep3 <- st_join(r19_bu, sep3, join = st_nearest_feature)

# *** recursive gc invocation problem without gc()?
gc()
nearest <- st_nearest_feature(r19_bu, sep3)
gc()
r19_bu_sep3$dist <- st_distance(r19_bu_sep3, sep3[nearest, ],
                               by_element = TRUE)
rm(nearest); gc()

summary(r19_bu_sep3$dist)

# View(st_drop_geometry(r19_bu_sep3))

r19_bu_sep3_gem_22 <- 
  st_join(r19_bu_sep3, gem_22, join = st_intersects)

# r19_bu_sep3_gem_22 %>%
#   filter(is.na(mun_id))

# tm_shape(gem_bfs) +
#   tm_polygons() +
#   tm_shape(r19_bu_sep3_gem_22 %>% filter(is.na(GMDNR)) %>% select(-r19_gdename)) +
#   tm_dots()

r19_bu_sep3_gem_22 <- r19_bu_sep3_gem_22 %>% 
  st_drop_geometry() %>% 
  relocate(mun_id, .after = r19_egid_snc)  

# View(r19_bu_sep3_gem_22)

write_rds(r19_bu_sep3_gem_22, "data/statpop/r19_bu_sep3_gem_22.rds")
```

```{r include=FALSE}
rm(r19_bu); gc()

r19_bu_sep3_gem_22 <- read_rds("data/statpop/r19_bu_sep3_gem_22.rds") %>% 
  select(-dist)
```

```{r}
temp <- r19_bu_sep3_gem_22 %>% 
  select(mun_id, ssep3, r19_nrpers_main) %>% 
  uncount(r19_nrpers_main) %>% 
  group_by(mun_id) %>% 
  summarise(pop = n(),
            # ssep3_mean = mean(ssep3),
            ssep3_median = median(ssep3)) %>% 
  ungroup() 

ssep3_gem_22_pop <- left_join(gem_22, temp) %>% 
  mutate(median_ssep3_pop_d = ntile(ssep3_median, 10)) %>% 
  mutate(median_ssep3_pop_d = factor(median_ssep3_pop_d,
                                     levels = 1:10,
                                     labels = c("1st - lowest", 
                                                "2", "3", "4", 
                                                "5th decile", 
                                                "6", "7", "8", "9", 
                                                "10th - highest")))

frq(ssep3_gem_22_pop$median_ssep3_pop_d)
```

```{r include=FALSE}
rm(temp); gc()
write_rds(ssep3_gem_22_pop, "data/ssep3_gem_22_pop.rds")
```

Final map using median index; bubbles scaled to number of people (2019)  

```{r echo=FALSE, layout="l-body-outset"}
ssep3_gem_22_pop %>% 
  tm_shape() +
  tm_dots(size = "pop", col = "median_ssep3_pop_d", 
          palette = "RdYlGn",
          scale = .5,  shape = 19)
```

<!-- ------------------------------------------------------------ --> 

# Associations - June vote

```{r}
covid_jun <- ssep3_gem_22_pop %>% 
  st_drop_geometry() %>% 
  left_join(covid_jun) %>% 
  as_tibble()
```

## Scatter {.tabset}

### Unweighted

```{r echo=FALSE, warning=FALSE}
covid_jun %>% 
  ggplot(aes(x = ssep3_median, y = jaStimmenInProzent)) + 
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.25) + 
  theme_ipsum_rc() +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

### Weighted

```{r echo=FALSE, warning=FALSE}
covid_jun %>% 
  ggplot(aes(x = ssep3_median, y = jaStimmenInProzent, size = pop)) + 
  geom_smooth(aes(weight = pop), method = "lm") +
  geom_point(alpha = 0.25) + 
  theme_ipsum_rc() +
  theme(legend.position = "none") +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

## Box plot

```{r echo=FALSE}
covid_jun %>% 
  ggplot(aes(x = median_ssep3_pop_d, y = jaStimmenInProzent)) + 
  geom_boxplot() +
  theme_ipsum_rc() +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

## Histograms

```{r echo=FALSE}
covid_jun %>% 
  ggplot(aes(x = jaStimmenInProzent, 
             y = median_ssep3_pop_d, 
             fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis_c(name = "% vote yes") +
  theme_ipsum_rc() +
  ylab("Swiss-SEP index decile") + xlab("% vote yes")
```

## Correlations

### Unweighted

```{r}
cor.test(covid_jun$ssep3_median, 
         covid_jun$jaStimmenInProzent, 
         method = "pearson")
```

### Weighted

```{r}
wtd.cor(covid_jun$ssep3_median, 
        covid_jun$jaStimmenInProzent, 
        weight = ssep3_gem_22_pop$pop)
```

## Outliers

### Lowest % yes

```{r}
covid_jun %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent < 30) %>% 
  datatable()
```

### Low SEP, high % yes

```{r}
covid_jun %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent > 60 & 
           as.numeric(median_ssep3_pop_d) <= 2) %>% 
  arrange(desc(jaStimmenInProzent)) %>% 
  datatable()
```

### High SEP, low % yes

```{r}
covid_jun %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent < 50 & 
           as.numeric(median_ssep3_pop_d) >= 8) %>% 
  arrange(desc(jaStimmenInProzent)) %>% 
  datatable()
```

<!-- ------------------------------------------------------------ --> 

# Associations - November vote

```{r}
covid_nov <- ssep3_gem_22_pop %>% 
  st_drop_geometry() %>% 
  left_join(covid_nov) %>% 
  as_tibble()
```

## Scatter {.tabset}

### Unweighted

```{r echo=FALSE, warning=FALSE}
covid_nov %>% 
  ggplot(aes(x = ssep3_median, y = jaStimmenInProzent)) + 
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.25) + 
  theme_ipsum_rc() +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

### Weighted

```{r echo=FALSE, warning=FALSE}
covid_nov %>% 
  ggplot(aes(x = ssep3_median, y = jaStimmenInProzent, size = pop)) + 
  geom_smooth(aes(weight = pop), method = "lm") +
  geom_point(alpha = 0.25) + 
  theme_ipsum_rc() +
  theme(legend.position = "none") +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

## Box plot

```{r echo=FALSE}
covid_nov %>% 
  ggplot(aes(x = median_ssep3_pop_d, y = jaStimmenInProzent)) + 
  geom_boxplot() +
  theme_ipsum_rc() +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

## Histograms

```{r echo=FALSE}
covid_nov %>% 
  ggplot(aes(x = jaStimmenInProzent, 
             y = median_ssep3_pop_d, 
             fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis_c(name = "% vote yes") +
  theme_ipsum_rc() +
  ylab("Swiss-SEP index decile") + xlab("% vote yes")
```

## Correlations

### Unweighted

```{r}
cor.test(covid_nov$ssep3_median, 
         covid_nov$jaStimmenInProzent, 
         method = "pearson")
```

### Weighted

```{r}
wtd.cor(covid_nov$ssep3_median, 
        covid_nov$jaStimmenInProzent, 
        weight = ssep3_gem_22_pop$pop)
```

## Outliers

### Lowest % yes

```{r}
covid_nov %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent < 30) %>% 
  datatable()
```

### Low SEP, high % yes

```{r}
covid_nov %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent > 60 & 
           as.numeric(median_ssep3_pop_d) <= 2) %>% 
  arrange(desc(jaStimmenInProzent)) %>% 
  datatable()
```

### High SEP, low % yes

```{r}
covid_nov %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent < 50 & 
           as.numeric(median_ssep3_pop_d) >= 8) %>% 
  arrange(desc(jaStimmenInProzent)) %>% 
  datatable()
```
