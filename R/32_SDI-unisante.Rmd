---
title: "Swiss-SEP 2.0"
description: "SDI from Unisante"
date: "`r Sys.Date()`"
author:
  - name: Radoslaw Panczak 
    url: https://github.com/RPanczak
    affiliation: ISPM
    affiliation_url: https://www.ispm.unibe.ch/
    orcid_id: 0000-0001-5141-683X
# bibliography: biblio.bib
output:
  distill::distill_article:
    highlight: pygments
    toc: true
    toc_depth: 1
    number_sections: true
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
options(scipen=999)
set.seed(12345)

library(pacman) 
p_load(tidyverse, scales, sf, tmap, tmaptools)

tmap_mode("view") # makes map interactive
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      cache = FALSE, 
                      # fig.width=8, fig.height=6, 
                      # out.width="800px", out.height="600px",
                      dpi=300)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

<!-- ------------------------------------------------------------ --> 

# Data

## Swiss-SEP 

Using version 3.0. 

```{r echo=FALSE}
sep3 <- read_rds("FINAL/RDS/ssep3_user_geo.Rds") %>% 
  select(gisid, ssep3, ssep3_d) %>% 
  mutate(ssep3_d = factor(ssep3_d,
                          levels = 1:10,
                          labels = c("1st - lowest", 
                                     "2", "3", "4", 
                                     "5th decile", 
                                     "6", "7", "8", "9", 
                                     "10th - highest")))
```

Dataset consists of `r scales::number(nrow(sep3), big.mark = ",")` n'hoods, each assigned to decile of index.

```{r}
st_drop_geometry(sep3) %>% 
  frq(ssep3_d)
```

## Medstat regions

SDI uses Medstat `Version 6.93` that includes:

> Update Mutationen PLZ der Post. Stand 01.01.2018

First, 2018 PLZ release from [cadastre.ch](https://www.cadastre.ch/en/services/service/registry/plz.html) is used to link to Medstat look up tables.  

```{r warning=FALSE}
plz <- st_read("data-raw/PLZ/2018/PLZO_PLZ.shp") %>% 
  select(PLZ) %>% 
  filter(PLZ < 9485)

plz %>%
  st_drop_geometry() %>% 
  group_by(PLZ) %>% 
  filter(n() > 1) %>% 
  ungroup() %>% 
  distinct()

# plz_mp <- plz %>% 
#   group_by(PLZ) %>% 
#   summarise(PLZ = first(PLZ)) %>%
#   st_cast("MULTIPOLYGON") %>% 
#   ungroup()

# plz_centr <- st_centroid(plz_mp)
```

PLZ dataset consists of `r scales::number(nrow(plz_mp), big.mark = ",")` regions.  

[Medstat](https://www.bfs.admin.ch/bfs/de/home/statistiken/gesundheit/nomenklaturen/medsreg.html) PLZ lookup tables were obtained from BfS.  

FIXME: switch to 6.93!

```{r}
medstat_lu <- readxl::read_xlsx("data-raw/BfS/Medstat/medstat_v6_96.xlsx", 
                                sheet = "REGION=CH", 
                                col_types = c("numeric", "skip", "text", "text", "text")) %>% 
  janitor::clean_names() %>% 
  rename(PLZ = npa_plz, medstat = med_stat) %>% 
  filter(medstat != "LIE")
```

```{r}
# map plzs that dont have a link
plz_mp %>% st_drop_geometry() %>% anti_join(medstat_lu)

# medstat plzs that dont exist on map
medstat_lu %>% anti_join(plz_mp)
```

```{r}
medstat <- plz %>%
  left_join(medstat_lu) %>% 
  group_by(medstat) %>% 
  summarise(medstat = first(medstat),
            name = first(name),
            kt = first(kt)) %>%
  st_cast("MULTIPOLYGON") %>% 
  ungroup() %>% 
  st_make_valid()
```

```{r}
table(st_is_valid(medstat))
qtm(medstat)

qtm(medstat %>% filter(is.na(medstat)))
```

## Unisante data

```{r}
unisante <- readxl::read_xlsx("data-raw/unisante/MedStat_SDI.xlsx") %>% 
  janitor::clean_names() %>% 
  rename(medstat = mdst04) %>% 
  filter(year == 2017) %>% 
  relocate(medstat)

length(unique(unisante$medstat))

# map medstats that dont have a link
medstat %>% st_drop_geometry() %>% anti_join(unisante)

# unisante medstats that dont exist on map
unisante %>% anti_join(medstat)

medstat %>% left_join(unisante)
```

<!-- ------------------------------------------------------------ --> 

# Comparison

## N'hood average SEP for Medstat

## Population based average SEP for Medstat



