---
title: "Swiss-SEP project"
description: "tobacco-19 law & municipality level SEP"
date: "`r Sys.Date()`"
author:
  - name: Radoslaw Panczak 
    url: https://github.com/RPanczak
    affiliation: ISPM
    affiliation_url: https://www.ispm.unibe.ch/
    orcid_id: 0000-0001-5141-683X
# bibliography: biblio.bib
output:
  distill::distill_article:
    highlight: pygments
    toc: true
    toc_depth: 1
    number_sections: true
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      # fig.width=8, fig.height=6, 
                      # out.width="800px", out.height="600px",
                      dpi=300)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(scipen=999)
set.seed(12345)

# removed from cran?
# devtools::install_github("politanch/swissdd")

library(pacman) 
p_load(tidyverse, haven, readxl, magrittr,
       sjmisc, weights, ggridges, hrbrthemes, DT,
       sf, tmap,
       swissdd)

tmap_mode("view")
```

# Data 

## Tabakwerbung

Data `swissdd` [package](https://github.com/politanch/swissdd)  

> Volksinitiative «Ja zum Schutz der Kinder und Jugendlichen vor Tabakwerbung»  

More info [here](https://www.admin.ch/gov/de/start/dokumentation/abstimmungen/20220213/volksinitiative-ja-zum-schutz-der-kinder-und-jugendlichen-vor-tabakwerbung.html).  

```{r}
tobacco <- get_nationalvotes(votedates = "2022-02-13", geolevel = "municipality") %>% 
  filter(name == "Volksinitiative «Ja zum Schutz der Kinder und Jugendlichen vor Tabakwerbung» (Kinder und Jugendliche ohne Tabakwerbung)") %>% 
  select(-name)

plot_nationalvotes(votedate = "2022-02-13", vote_id = 6520, geolevel = "municipality")
```

Excluding cantonal votes from abroad:  

```{r}
tobacco %>% 
  filter(str_detect(mun_name, fixed("Ausland")) | str_detect(mun_name, fixed("l'étranger"))) %>% 
  select(mun_name, jaStimmenAbsolut, jaStimmenInProzent)
```

```{r}
tobacco %<>% 
  filter(! str_detect(mun_name, fixed("Ausland"))) %>% 
  filter(! str_detect(mun_name, fixed("l'étranger"))) %>% 
  mutate(mun_id = as.numeric(mun_id))
```

Dataset consists of `r scales::number(length(unique(tobacco$mun_id)), big.mark = ",")` communities.

## Municipalities

swissBOUNDARIES3D **Jan 2022** from [swisstopo](https://shop.swisstopo.admin.ch/en/products/landscape/boundaries3D).  

```{r include=FALSE}
gem_22 <- read_rds("../ISPM_geo/data/swisstopo/swissBOUNDARIES3D/gem_22.Rds") %>% 
  st_transform(crs = 2056) %>% 
  rename(mun_id = GMDNR)
```

swisstopo dataset consists of `r scales::number(length(unique(gem_22$mun_id)), big.mark = ",")` municipalities.  

```{r eval=FALSE, include=FALSE}
length(unique(gem_22$mun_id))

st_drop_geometry(gem_22) %>% 
  anti_join(tobacco)

tobacco %>% 
  anti_join(st_drop_geometry(gem_22))
```

## Link

Using `GMDNR` / `mun_id` for deterministic linkage.  

```{r}
gem_22 %<>% 
  left_join(tobacco)
```

There are few communities that do not exist in the voting dataset:  

```{r echo=FALSE}
gem_22 %>% 
  st_drop_geometry() %>% 
  filter(is.na(jaStimmenInProzent)) %>% 
  select(mun_id) %>% 
  rename(GMDNR = mun_id) %>% 
  left_join(st_drop_geometry(read_rds("../ISPM_geo/data/swisstopo/swissBOUNDARIES3D/gem_22.Rds")))
```

## Swiss-SEP

```{r}
ssep3_gem_22_pop <- read_rds("data/ssep3_gem_22_pop.rds")

tobacco <- ssep3_gem_22_pop %>% 
  st_drop_geometry() %>% 
  left_join(tobacco) %>% 
  as_tibble()
```

```{r include=FALSE}
rm(ssep3_gem_22_pop); gc()
```

# Associations

## Scatter

### Unweighted

```{r echo=FALSE, warning=FALSE}
tobacco %>% 
  ggplot(aes(x = ssep3_median, y = jaStimmenInProzent)) + 
  geom_smooth(method = "lm") +
  geom_point(alpha = 0.25) + 
  theme_ipsum_rc() +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

### Weighted

```{r echo=FALSE, warning=FALSE}
tobacco %>% 
  ggplot(aes(x = ssep3_median, y = jaStimmenInProzent, size = pop)) + 
  geom_smooth(aes(weight = pop), method = "lm") +
  geom_point(alpha = 0.25) + 
  theme_ipsum_rc() +
  theme(legend.position = "none") +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

## Box plot

```{r echo=FALSE}
tobacco %>% 
  ggplot(aes(x = median_ssep3_pop_d, y = jaStimmenInProzent)) + 
  geom_boxplot() +
  theme_ipsum_rc() +
  xlab("Swiss-SEP index") + ylab("% vote yes")
```

## Histograms

```{r echo=FALSE}
tobacco %>% 
  ggplot(aes(x = jaStimmenInProzent, 
             y = median_ssep3_pop_d, 
             fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis_c(name = "% vote yes") +
  theme_ipsum_rc() +
  ylab("Swiss-SEP index decile") + xlab("% vote yes")
```

## Correlations

### Unweighted

```{r}
cor.test(tobacco$ssep3_median, 
         tobacco$jaStimmenInProzent, 
         method = "pearson")
```

### Weighted

```{r}
wtd.cor(tobacco$ssep3_median, 
        tobacco$jaStimmenInProzent, 
        weight = tobacco$pop)
```

## Outliers

### Lowest % yes

```{r}
tobacco %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent < 30) %>% 
  datatable()
```

### Low SEP, high % yes

```{r}
tobacco %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent > 60 & 
           as.numeric(median_ssep3_pop_d) <= 2) %>% 
  arrange(desc(jaStimmenInProzent)) %>% 
  datatable()
```

### High SEP, low % yes

```{r}
tobacco %>% 
  select(-ssep3_median) %>% 
  mutate(jaStimmenInProzent = scales::number(jaStimmenInProzent, accuracy = 0.1)) %>% 
  filter(jaStimmenInProzent < 50 & 
           as.numeric(median_ssep3_pop_d) >= 8) %>% 
  arrange(desc(jaStimmenInProzent)) %>% 
  datatable()
```