---
title: "Swiss-SEP project"
description: "Aggregating point data to communities"
date: "`r Sys.Date()`"
author:
  - name: Radoslaw Panczak 
    url: https://github.com/RPanczak
    affiliation: ISPM
    affiliation_url: https://www.ispm.unibe.ch/
    orcid_id: 0000-0001-5141-683X
# bibliography: biblio.bib
output:
  distill::distill_article:
    highlight: pygments
    toc: true
    toc_depth: 1
    number_sections: true
editor_options: 
  chunk_output_type: console
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      # fig.width=8, fig.height=6, 
                      # out.width="800px", out.height="600px",
                      dpi=300)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
options(scipen=999)
set.seed(12345)
library(pacman) 
p_load(tidyverse, haven, 
       sjmisc, sjPlot,
       sf, tmap)

tmap_mode("view")
```

# Raw data 

## Communities

swissBOUNDARIES3D **2021** from [swisstopo](https://shop.swisstopo.admin.ch/en/products/landscape/boundaries3D)

Generalisierte Gemeindegrenzen **2021** from [BfS](https://www.bfs.admin.ch/bfs/de/home/dienstleistungen/geostat/geodaten-bundesstatistik/administrative-grenzen/generalisierte-gemeindegrenzen.html)

```{r include=FALSE}
gem_st <- read_rds("../ISPM_geo/data/swisstopo/swissBOUNDARIES3D/gem_21.Rds") %>% 
  st_transform(crs = 2056) 

gem_bfs <- read_rds("../ISPM_geo/data/ag-b-00.03-875-gg21/gem_21.Rds") %>% 
  st_transform(crs = 2056) 

lake <- read_rds("../ISPM_geo/data/ag-b-00.03-875-gg21/lake_21.Rds") %>% 
  st_transform(crs = 2056) 

canton <- read_rds("../ISPM_geo/data/ag-b-00.03-875-gg21/canton_21.Rds") %>% 
  st_transform(crs = 2056) 

# plot(st_geometry(gem_bfs))
```

```{r eval=FALSE, include=FALSE}
# correctly three gems with no people
length(unique(gem_st$GMDNR))
length(unique(gem_bfs$GMDNR))

gem_bfs %>% 
  anti_join(st_drop_geometry(gem_st)) %>% 
  tm_shape() +
  tm_dots()

# different precision of boundaries
tm_shape(gem_bfs %>% filter(GMDNR == 351)) +
  tm_polygons(col = "green", alpha = 0.5) +
  tm_shape(gem_st %>% filter(GMDNR == 351)) +
  tm_borders(col = "red", lty = "dotted", alpha = 0.75)
```

Dataset consists of `r scales::number(length(unique(gem_bfs$GMDNR)), big.mark = ",")` communities.

## Swiss-SEP 

Using version 1.0. 

```{r echo=FALSE}
sep1 <- read_rds("data/Swiss-SEP1/ssep_user_geo.Rds") %>% 
  st_transform(crs = 2056) %>% 
  select(v0_buildid, ssep, ssep_d) %>% 
  rename(ssep1 = ssep,
         ssep1_d = ssep_d) %>% 
  mutate(ssep1_d = factor(ssep1_d,
                          levels = 1:10,
                          labels = c("1st - lowest", 
                                     "2", "3", "4", 
                                     "5th decile", 
                                     "6", "7", "8", "9", 
                                     "10th - highest")))

# sep1 %>% 
#   filter(v0_buildid == 982041) %>% 
#   qtm()

# sep2 <- read_rds("data/Swiss-SEP2/ssep2_user_geo.Rds") %>% 
#   st_transform(crs = 2056) %>% 
#   select(gisid, ssep2, ssep2_d) %>% 
#   mutate(ssep2_d = factor(ssep2_d,
#                           levels = 1:10,
#                           labels = c("1st - lowest", 
#                                      "2", "3", "4", 
#                                      "5th decile", 
#                                      "6", "7", "8", "9", 
#                                      "10th - highest")))
```

Dataset consists of `r scales::number(nrow(sep1), big.mark = ",")` n'hoods, each assigned to decile of index.

```{r}
st_drop_geometry(sep1) %>% 
  frq(ssep1_d)
```

## STATPOP

```{r include=FALSE}
r18_bu_orig <- read_dta("../SNC_core/data-raw/statpop/r18_bu_orig.dta")
# View(r18_bu_orig)

r18_bu <- r18_bu_orig %>% 
  filter(between(r18_gklas, 1110, 1122)) %>% 
  filter(!is.na(r18_gklas)) %>% 
  select(-r18_cant, -r18_cant_sh,
         -r18_ecoord_h, -r18_ncoord_h, 
         -r18_plzz,
         -r18_gklas, -r18_fgkod, -r18_buildper, 
         -r18_nrfloor, -r18_nrdwell, 
         -r18_quarter, -r18_comm, -r18_buildcat) %>% 
  select(-r18_nrpers_total, -r18_nrpers_perm) %>% 
  # filter(!is.na(r18_ncoord)) %>% 
  # filter(!is.na(r18_ecoord)) %>% 
  st_as_sf(coords = c("r18_ecoord", "r18_ncoord"), 
           crs = 2056,
           remove = TRUE)
```

Using data from `STATPOP` **2018**. Excluding `r scales::number(nrow(filter(r18_bu_orig, !between(r18_gklas, 1110, 1122))), big.mark = ",")` nonresidential buildings and `r scales::number(nrow(filter(r18_bu_orig, is.na(r18_gklas))), big.mark = ",")` buildings missing information on classifications. 

Used dataset consists of `r scales::number(nrow(r18_bu), big.mark = ",")` buildings.

The nearest building with SSEP 1 was found; point dataset was then overlaid with PLZ boundaries and summary measures of population based index were created and population level SEP was aggregated by PLZ. 

`r18_nrpers_main` was used for population - slightly different populations would be obtained with different conceptual models of *residential populations* by using either `r18_nrpers_total` or `r18_nrpers_perm` variables

```{r include=FALSE}
rm(r18_bu_orig)
gc()
```

<!-- ------------------------------------------------------------ --> 

# Community averages

## 'nhood based

```{r include=FALSE}
ssep1_gem_21 <- 
  st_join(sep1, gem_st, join = st_intersects) 

tm_shape(gem_bfs) +
  tm_polygons() +
  tm_shape(ssep1_gem_21 %>% filter(is.na(GMDNR))) +
  tm_dots()

ssep1_gem_21_neigh <- ssep1_gem_21 %>% 
  st_drop_geometry() %>% 
  relocate(GMDNR, .after = v0_buildid) %>% 
  # covering 4 points outside of the map > lakes & borders
  mutate(GMDNR = ifelse(v0_buildid ==  924650,  158, GMDNR)) %>% 
  mutate(GMDNR = ifelse(v0_buildid ==  982041, 6434, GMDNR)) %>% 
  mutate(GMDNR = ifelse(v0_buildid == 1167211, 5586, GMDNR)) %>% 
  group_by(GMDNR) %>% 
  summarise(n = n(),
            ssep1_mean = mean(ssep1),
            ssep1_median = median(ssep1)) %>% 
  ungroup() 

breaks1 <- sep1 %>% 
  st_drop_geometry() %>% 
  group_by(ssep1_d) %>% 
  summarize(min = min(ssep1),
            max = max(ssep1))

# sep1$temp <- cut(sep1$ssep1, breaks = c(breaks1$min, 100),
#                  include.lowest = TRUE,
#                  labels = c("1st - lowest",
#                             "2", "3", "4",
#                             "5th decile",
#                             "6", "7", "8", "9",
#                             "10th - highest"))
# 
# table(sep1$ssep1_d, sep1$temp)
# sep1$temp <- NULL

ssep1_gem_21_neigh_geo <- inner_join(gem_bfs, ssep1_gem_21_neigh) %>% 
  filter(!is.na(ssep1_median)) %>% 
  mutate(median_ssep1_samp_d = ntile(ssep1_median, 10)) %>% 
  mutate(median_ssep1_samp_d = factor(median_ssep1_samp_d,
                                      levels = 1:10,
                                      labels = c("1st - lowest", 
                                                 "2", "3", "4", 
                                                 "5th decile", 
                                                 "6", "7", "8", "9", 
                                                 "10th - highest")))

ssep1_gem_21_neigh_geo$median_ssep1_full_d <- cut(ssep1_gem_21_neigh_geo$ssep1_median, 
                                                  breaks = c(breaks1$min, 100),
                                                  include.lowest = TRUE,
                                                  labels = c("1st - lowest", 
                                                             "2", "3", "4", 
                                                             "5th decile", 
                                                             "6", "7", "8", "9", 
                                                             "10th - highest"))

write_rds(ssep1_gem_21_neigh_geo, "data/ssep1_gem_21_neigh_geo.rds")
```

Watch out for small n! Here some examples with communities below 20 n'hoods

```{r}
ssep1_gem_21_neigh_geo %>% 
  st_drop_geometry() %>% 
  select(GMDNR, n) %>% 
  inner_join(st_drop_geometry(gem_st)) %>% 
  filter(n < 19) %>% 
  arrange(n)

ssep1_gem_21_neigh_geo %>% 
  filter(n < 19) %>% 
  qtm(borders = "red", fill = "red")
```

### Final map using median index

Bubbles scaled to number of 'nhoods.

```{r, layout="l-body-outset"}
ssep1_gem_21_neigh_geo %>% 
  tm_shape() +
  tm_dots(size = "n", col = "ssep1_median", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

### Deciles using sample of PLZs vs 'original' deciles

```{r}
frq(ssep1_gem_21_neigh_geo$median_ssep1_samp_d)
frq(ssep1_gem_21_neigh_geo$median_ssep1_full_d)
```

```{r, layout="l-page"}
ssep1_gem_21_neigh_geo %>% 
  tm_shape() +
  tm_fill(col = c("median_ssep1_samp_d", "median_ssep1_full_d"), 
          border.col = "white",
          palette = "RdYlGn")
```

## Population based

```{r eval=FALSE, include=FALSE}
# join to sep1
r18_bu_sep <- st_join(r18_bu, sep1, join = st_nearest_feature)

nearest <- st_nearest_feature(r18_bu, sep1)
r18_bu_sep$dist1 <- st_distance(r18_bu_sep, sep1[nearest, ], by_element = TRUE)
rm(nearest)

summary(r18_bu_sep$dist1)

# join to sep2
# r18_bu_sep <- st_join(r18_bu_sep, sep2, join = st_nearest_feature)

# # nearest <- st_nearest_feature(r18_bu_sep, sep2)
# # r18_bu_sep$dist2 <- st_distance(r18_bu_sep, sep2[nearest, ], by_element = TRUE)
# # rm(nearest)

# summary(r18_bu_sep$dist2)

# View(st_drop_geometry(r18_bu_sep))

r18_bu_sep_gem21 <- 
  st_join(r18_bu_sep, gem_st, join = st_intersects)

# r18_bu_sep_gem21 %>%
#   filter(is.na(GMDNR))
# 
# tm_shape(gem_bfs) +
#   tm_polygons() +
#   tm_shape(r18_bu_sep_gem21 %>% filter(is.na(GMDNR)) %>% select(-r18_gdename)) +
#   tm_dots()

r18_bu_sep_gem21 <- r18_bu_sep_gem21 %>% 
  st_drop_geometry() %>% 
  relocate(GMDNR, .after = r18_egid) %>% 
  # covering 6 points outside of the map > lakes issues
  mutate(GMDNR = ifelse(r18_egid == 899324592, 4806, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 899324589, 4806, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 899324588, 4806, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 898609635,  756, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 898533015, 6417, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 898563492,  942, GMDNR))  

# View(r18_bu_sep_gem21)

write_rds(r18_bu_sep_gem21, "data/statpop/r18_bu_sep_gem21.rds")
```

```{r}
r18_bu_sep_gem21 <- read_rds("data/statpop/r18_bu_sep_gem21.rds") 
```

```{r}
ssep1_gem_21_pop <- r18_bu_sep_gem21 %>% 
  select(GMDNR, ssep1, r18_nrpers_main) %>% 
  uncount(r18_nrpers_main) %>% 
  group_by(GMDNR) %>% 
  summarise(pop = n(),
            ssep1_mean = mean(ssep1),
            ssep1_median = median(ssep1)) %>% 
  ungroup() 

ssep1_gem_21_pop_geo <- left_join(gem_bfs, ssep1_gem_21_pop) %>% 
  filter(!is.na(ssep1_median)) %>% 
  mutate(median_ssep1_samp_d = ntile(ssep1_median, 10)) %>% 
  mutate(median_ssep1_samp_d = factor(median_ssep1_samp_d,
                                      levels = 1:10,
                                      labels = c("1st - lowest", 
                                                 "2", "3", "4", 
                                                 "5th decile", 
                                                 "6", "7", "8", "9", 
                                                 "10th - highest")))

ssep1_gem_21_pop_geo$median_ssep1_full_d <- cut(ssep1_gem_21_pop_geo$ssep1_median, 
                                                breaks = c(breaks1$min, 100),
                                                include.lowest = TRUE,
                                                labels = c("1st - lowest", 
                                                           "2", "3", "4", 
                                                           "5th decile", 
                                                           "6", "7", "8", "9", 
                                                           "10th - highest"))

write_rds(ssep1_gem_21_pop_geo, "data/ssep1_gem_21_pop_geo.rds")
```

### Final map using median index

Bubbles scaled to number of people (2018)

```{r, layout="l-body-outset"}
ssep1_gem_21_pop_geo %>% 
  tm_shape() +
  tm_dots(size = "pop", col = "ssep1_median", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

### Deciles using sample of communities vs 'original' deciles

```{r}
frq(ssep1_gem_21_pop_geo$median_ssep1_samp_d)
frq(ssep1_gem_21_pop_geo$median_ssep1_full_d)
```

```{r, layout="l-page"}
ssep1_gem_21_pop_geo %>% 
  tm_shape() +
  tm_fill(col = c("median_ssep1_samp_d", "median_ssep1_full_d"), 
          palette = "RdYlGn")
```

<!-- ------------------------------------------------------------ --> 

# Maps

## All CH gem

```{r}
logo <- magick::image_read("carto/snc.png")
magick::image_info(logo)

st_bbox(canton)$xmax
st_bbox(lake)
```

```{r}
ggplot() + 
  geom_sf(data = lake, color = NA,  fill = rgb(176, 229, 255, max = 255)) + 
  geom_sf(data = ssep1_gem_21_pop_geo,
          aes(fill = median_ssep1_samp_d),
          color = "white", size = 0.2, alpha = 0.85) +
  geom_sf(data = canton, fill = NA, color = gray(.5), size = 0.5) +
  scale_fill_brewer(palette = "RdYlGn") +
  theme_void() + 
  theme(legend.position = c(.05, .95), 
        legend.justification = c("left", "top"),
        legend.direction = 'vertical') +
  guides(colour = guide_legend(title = "Swiss-SEP",
                               override.aes = list(alpha = 1, shape = 16, size = 3))) +
  labs(fill = "Index decile") +
  annotation_custom(grid::rasterGrob(logo), 
                    xmin = st_bbox(canton)$xmax - 23400*2, 
                    xmax = st_bbox(canton)$xmax, 
                    ymin = st_bbox(lake)$ymin, 
                    ymax = st_bbox(lake)$ymin + 11000*2) 

ggsave("carto/tamedia/sep-gem21.png", width = 297, height = 210, 
       units = "mm", dpi = 300)
```

## All CH point

```{r}
# for experiments
sep1_samp <- sep1 %>% 
  sample_frac(0.01)

# display.brewer.pal(n = 10, name = "RdYlGn") 

# # sf plotting
plot(st_geometry(canton),
     col = NA, border = "gray50", lwd = 0.1,
     reset = FALSE)
plot(st_geometry(lake),
     # col = rgb(0, 135, 208, max = 255), border = NA,
     # col = rgb(156, 213, 248, max = 255), border = NA,
     col = rgb(176, 229, 255, max = 255), border = NA,
     add = TRUE)
plot(ssep1_samp["ssep1_d"],
     pal = RColorBrewer::brewer.pal(n = 10, name = "RdYlGn"),
     cex = 0.1, pch = 16,
     add = TRUE)
```


```{r}
ggplot() + 
  geom_sf(data = lake, color = NA, fill = rgb(176, 229, 255, max = 255)) + 
  geom_sf(data = canton, fill = NA, color = gray(.5), size = 0.25) +
  # geom_sf(data = sep1_samp, aes(colour = ssep1_d), 
  #         alpha = 0.66, shape = ".", size = 0.1) +
  geom_sf(data = sep1, aes(colour = ssep1_d),
          alpha = 0.66, shape = ".", size = 0.1) +
  scale_colour_brewer(palette = "RdYlGn") +
  theme_void() + 
  theme(legend.position = c(.05, .95), 
        legend.justification = c("left", "top"),
        legend.direction = 'vertical') +
  guides(colour = guide_legend(title = "Swiss-SEP",
                               override.aes = list(alpha = 1, shape = 16, size = 3))) +
  annotation_custom(grid::rasterGrob(logo), 
                    xmin = st_bbox(canton)$xmax - 23400*2, 
                    xmax = st_bbox(canton)$xmax, 
                    ymin = st_bbox(lake)$ymin, 
                    ymax = st_bbox(lake)$ymin + 11000*2) 

ggsave("carto/tamedia/sep-dots.png", width = 297, height = 210, 
       units = "mm", dpi = 300)
```

```{r}
ssep1_gem_21_pop_geo %>% 
  select(GMDNR, GMDNAME, ssep1_median, median_ssep1_samp_d) %>% 
  st_write("carto/tamedia/ssep1_gem_21_pop_geo.shp", delete_dsn = TRUE)

ssep1_gem_21_pop_geo %>% 
  st_drop_geometry() %>% 
  select(GMDNR, GMDNAME, ssep1_median, median_ssep1_samp_d) %>% 
  write_csv("carto/tamedia/ssep1_gem_21_pop_geo.csv")
```

## Lausanne agglo point

```{r}
agglo_21 <- read_rds("../ISPM_geo/data/Raumgliederungen/agglo_21.Rds") %>% 
  filter(agglomerationen_2012 == 5586) %>% 
  select(bfs_gde_nummer)

lausanne_agglo <- gem_bfs %>% 
  filter(GMDNR %in% agglo_21$bfs_gde_nummer)

plot(st_geometry(lausanne_agglo))

st_crs(lausanne_agglo) == st_crs(lake) 

plot(st_geometry(st_union(lausanne_agglo)))

plot(st_geometry(st_crop(canton, st_bbox(lausanne_agglo))))
```

```{r}
ggplot() + 
  geom_sf(data = st_crop(lake, st_bbox(lausanne_agglo)), 
          color = NA, fill = rgb(176, 229, 255, max = 255)) + 
  geom_sf(data = lausanne_agglo, 
          fill = NA, color = gray(.5), size = 0.25) +
  geom_sf(data = st_crop(canton, st_bbox(lausanne_agglo)), 
          fill = NA, color = gray(.5), size = 0.95) +
  # geom_sf(data = st_crop(sep1_samp, st_bbox(lausanne_agglo)), 
  #         aes(colour = ssep1_d),
  #         alpha = 0.66, shape = ".", size = 0.1) +
  geom_sf(data = st_crop(sep1, st_bbox(lausanne_agglo)),
          aes(colour = ssep1_d),
          alpha = 0.66, shape = ".", size = 0.1) +
  scale_colour_brewer(palette = "RdYlGn") +
  theme_void() + 
  theme(legend.position = c(.05, .95), 
        legend.justification = c("left", "top"),
        legend.direction = 'vertical',
        legend.background = element_rect(fill = "white", 
                                         size = 0.5, linetype = "solid")) +
  guides(colour = guide_legend(title = "Swiss-SEP",
                               override.aes = list(alpha = 1, shape = 16, size = 3))) +
  annotation_custom(grid::rasterGrob(logo), 
                    xmin = st_bbox(st_crop(canton, st_bbox(lausanne_agglo)))$xmax - 2340*2, 
                    xmax = st_bbox(st_crop(canton, st_bbox(lausanne_agglo)))$xmax - 5, 
                    ymin = st_bbox(st_crop(lake, st_bbox(lausanne_agglo)))$ymin + 5, 
                    ymax = (st_bbox(st_crop(lake, st_bbox(lausanne_agglo)))$ymin + 1100*2)
  ) 

ggsave("carto/tamedia/sep-dots-lausanne_agglo.png", width = 297, height = 210, 
       units = "mm", dpi = 300)
```








## Lausanne agglo point

```{r}
lausanne <- gem_bfs %>% 
  filter(GMDNR == 5586) 
  
lausanne_buff <- st_buffer(lausanne, dist = 500)

plot(st_geometry(lausanne_buff))
plot(st_geometry(lausanne), add = TRUE)
```

```{r}
ggplot() + 
  geom_sf(data = st_crop(lake, st_bbox(lausanne_buff)), 
          color = NA, fill = rgb(176, 229, 255, max = 255)) + 
  geom_sf(data = lausanne, 
          fill = NA, color = gray(.5), size = 0.5) +
  geom_sf(data = st_crop(canton, st_bbox(lausanne_buff)), 
          fill = NA, color = gray(.5), size = 0.95) +
  # geom_sf(data = st_crop(sep1_samp, st_bbox(lausanne_buff)),
  #         aes(colour = ssep1_d),
  #         alpha = 0.66, shape = 20, size = 0.7) +
  geom_sf(data = st_crop(sep1, st_bbox(lausanne_buff)),
          aes(colour = ssep1_d),
          alpha = 0.66, shape = 20, size = 0.7) +
  scale_colour_brewer(palette = "RdYlGn") +
  theme_void() + 
  theme(legend.position = c(.05, .95), 
        legend.justification = c("left", "top"),
        legend.direction = 'horizontal',
        legend.background = element_rect(fill = "white", 
                                         size = 0.5, linetype = "solid")) +
  guides(colour = guide_legend(title = "Swiss-SEP",
                               override.aes = list(alpha = 1, shape = 16, size = 3))) +
  annotation_custom(grid::rasterGrob(logo), 
                    xmin = st_bbox(st_crop(canton, st_bbox(lausanne_buff)))$xmax - 234*5, 
                    xmax = st_bbox(st_crop(canton, st_bbox(lausanne_buff)))$xmax - 25, 
                    ymin = st_bbox(st_crop(lake, st_bbox(lausanne_buff)))$ymin + 25, 
                    ymax = st_bbox(st_crop(lake, st_bbox(lausanne_buff)))$ymin + 110*5
  ) 

ggsave("carto/tamedia/sep-dots-lausanne.png", width = 297, height = 210, 
       units = "mm", dpi = 300)
```